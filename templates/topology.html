<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Topology Map - LeakAgent</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js for network visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #171717;
        }

        .network-svg {
            background: #1f2937;
            border-radius: 8px;
        }

        .node {
            cursor: pointer;
            stroke-width: 2;
        }

        .node.junction {
            fill: #3b82f6;
            stroke: #1d4ed8;
        }

        .node.reservoir {
            fill: #10b981;
            stroke: #047857;
        }

        .node.tank {
            fill: #f59e0b;
            stroke: #d97706;
        }

        .link {
            cursor: pointer;
        }

        .link.pipe {
            stroke: #6b7280;
        }

        .link.pump {
            stroke: #ef4444;
        }

        .link.valve {
            stroke: #8b5cf6;
        }

        .node:hover,
        .link:hover {
            filter: brightness(1.2);
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
        }

        .network-item {
            transition: all 0.2s ease;
        }

        .network-item:hover {
            background-color: #374151;
        }

        .network-item.selected {
            background-color: #1d4ed8;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #171717;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4A4A4A;
            border-radius: 4px;
            border: 2px solid #171717;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6c6c6c;
        }
    </style>
</head>

<body class="text-gray-200">
    <!-- Top Navigation Bar -->
    <nav class="bg-gray-800 border-b border-white/10 px-4 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <h1 class="text-xl font-semibold text-white">LeakAgent Vertical Water Model</h1>
                <div class="flex space-x-4">
                    <a href="/"
                        class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-colors">
                        üí¨ Smart Chat
                    </a>
                    <a href="/topology"
                        class="px-3 py-2 rounded-md text-sm font-medium text-white bg-gray-700 hover:bg-gray-600 transition-colors">
                        üó∫Ô∏è Topology Map
                    </a>
                </div>
            </div>
            <div class="text-sm text-gray-400">
                Network Topology Visualization and Data Analysis
            </div>
        </div>
    </nav>

    <div class="flex h-[calc(100vh-60px)]">
        <!-- Left Sidebar -->
        <aside class="w-80 bg-gray-900 border-r border-white/10 flex flex-col">
            <!-- Network Selection from RAG Storage -->
            <div class="p-4 border-b border-white/10">
                <h2 class="text-lg font-semibold mb-4">üìÅ Cached Networks</h2>

                <div id="network-list" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar">
                    <div class="text-center text-gray-500 py-4">
                        <div
                            class="animate-spin w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-2">
                        </div>
                        Loading...
                    </div>
                </div>

                <!-- Load Button -->
                <button id="load-topology-btn"
                    class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    üó∫Ô∏è Load Topology Map
                </button>
            </div>

            <!-- Network Info -->
            <div class="p-4 border-b border-white/10">
                <h3 class="text-sm font-medium text-gray-400 mb-2">üìä Network Info</h3>
                <div id="network-info" class="text-sm text-gray-300 space-y-1">
                    <div>Please select a network</div>
                </div>
            </div>

            <!-- Color Mode Toggle -->
            <div class="p-4">
                <h3 class="text-sm font-medium text-gray-400 mb-2">üé® Color Mode</h3>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="show-hydraulics"
                        class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                    <label for="show-hydraulics" class="text-sm text-gray-300">Show Avg Hydraulic Data</label>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative">
            <!-- Toolbar -->
            <div class="bg-gray-800 border-b border-white/10 px-4 py-3">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-lg font-semibold">Network Topology Map</h2>
                        <div id="current-file-info" class="text-sm text-gray-400">
                            No network selected
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="zoom-in-btn"
                            class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                            üîç+
                        </button>
                        <button id="zoom-out-btn"
                            class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                            üîç-
                        </button>
                        <button id="reset-view-btn"
                            class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                            üéØ Reset View
                        </button>
                        <button id="legend-toggle"
                            class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                            üé® Legend
                        </button>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="flex items-center justify-between space-x-6">
                    <!-- Size Control -->
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-400">Nodes:</span>
                            <input type="range" id="node-size-slider" min="0.0" max="3" step="0.1" value="1"
                                class="w-20 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-400">Links:</span>
                            <input type="range" id="link-size-slider" min="0.0" max="3" step="0.1" value="1"
                                class="w-20 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>

                    <!-- ID Display Control -->
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="show-node-ids"
                                class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            <label for="show-node-ids" class="text-sm text-gray-400">Node ID</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="show-link-ids"
                                class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            <label for="show-link-ids" class="text-sm text-gray-400">Link ID</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization Area -->
            <div class="flex-1 p-4">
                <div id="topology-container"
                    class="w-full h-full bg-gray-800 rounded-lg border border-white/10 relative">
                    <div id="loading-indicator" class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-6xl mb-4">üó∫Ô∏è</div>
                            <div class="text-xl text-gray-400">Select a cached network to start visualization</div>
                            <div class="text-sm text-gray-500 mt-2">Networks are loaded from rag_storage cache</div>
                        </div>
                    </div>
                    <!-- Floating Legend -->
                    <div id="legend-panel"
                        class="absolute top-4 right-4 z-10 bg-gray-800/95 backdrop-blur-sm border border-white/20 rounded-lg p-3 shadow-lg min-w-[180px]"
                        style="display: none;">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-300">üé® Legend</h3>
                            <button id="legend-close"
                                class="text-gray-400 hover:text-white text-lg leading-none">&times;</button>
                        </div>
                        <div class="space-y-3 text-xs">
                            <!-- Node Types -->
                            <div class="space-y-1">
                                <div class="text-xs text-gray-400 font-medium">Node Type</div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-500"></div>
                                    <span class="text-gray-300">Junction</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
                                    <span class="text-gray-300">Reservoir</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                                    <span class="text-gray-300">Tank</span>
                                </div>
                            </div>

                            <!-- Link Type -->
                            <div class="space-y-1">
                                <div class="text-xs text-gray-400 font-medium">Link Type</div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-5 h-0.5 bg-gray-500"></div>
                                    <span class="text-gray-300">Pipe</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-5 h-1 bg-red-500"></div>
                                    <span class="text-gray-300">Pump</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-5 h-1 bg-purple-500"></div>
                                    <span class="text-gray-300">Valve</span>
                                </div>
                            </div>

                            <!-- Hydraulic Data Legend (shown when hydraulics toggled on) -->
                            <div id="data-legend" class="space-y-1" style="display: none;">
                                <div class="text-xs text-gray-400 font-medium">Avg Hydraulic Data</div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-400"></div>
                                    <span class="text-gray-300">Low Pressure</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2.5 h-2.5 rounded-full bg-red-400"></div>
                                    <span class="text-gray-300">High Pressure</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-5 h-0.5 bg-green-400"></div>
                                    <span class="text-gray-300">Pos Flow</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-5 h-0.5 bg-red-400"></div>
                                    <span class="text-gray-300">Neg Flow</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <svg id="network-svg" class="w-full h-full network-svg" style="display: none;"></svg>
                </div>
            </div>
        </main>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip" style="display: none;"></div>

    <script>
        // Global variables
        let selectedNetwork = null;
        let networkData = null;
        let svg = null;
        let g = null;
        let zoom = null;
        let nodeElements = null;
        let linkElements = null;
        let nodeLabels = null;
        let linkLabels = null;
        let nodeSizeScale = 1;
        let linkSizeScale = 1;
        let showNodeIds = false;
        let showLinkIds = false;
        let showHydraulics = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadRagNetworks();
            initializeVisualization();
        });

        // Load cached RAG networks
        async function loadRagNetworks() {
            try {
                const response = await fetch('/api/rag_networks');
                const data = await response.json();

                const container = document.getElementById('network-list');

                if (data.success && data.networks.length > 0) {
                    container.innerHTML = '';
                    data.networks.forEach(net => {
                        const item = createNetworkItem(net);
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">No cached networks found.<br><span class="text-xs">Upload an INP file via Smart Chat to create cache.</span></div>';
                }
            } catch (error) {
                console.error('Failed to load RAG networks:', error);
                document.getElementById('network-list').innerHTML = '<div class="text-center text-red-500 py-4">Loading failed</div>';
            }
        }

        // Create network list item element
        function createNetworkItem(net) {
            const div = document.createElement('div');
            div.className = 'network-item p-3 rounded-lg border border-gray-700 cursor-pointer';
            div.dataset.md5 = net.md5;

            const size = (net.size / 1024).toFixed(1) + ' KB';
            const date = new Date(net.modified * 1000).toLocaleDateString('en-US');
            const nodeCount = net.stats.node_count || '?';
            const linkCount = net.stats.link_count || '?';

            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">üìÑ</span>
                            <span class="text-sm font-medium truncate">${net.filename}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            ${nodeCount} nodes ‚Ä¢ ${linkCount} links ‚Ä¢ ${size}
                        </div>
                        <div class="text-xs text-gray-500 mt-0.5">
                            ${date}
                        </div>
                    </div>
                </div>
            `;

            div.addEventListener('click', () => {
                // Deselect others
                document.querySelectorAll('#network-list .network-item').forEach(item => {
                    item.classList.remove('selected');
                });
                div.classList.add('selected');
                selectedNetwork = net;
                updateNetworkInfo(net);
                document.getElementById('load-topology-btn').disabled = false;
            });

            return div;
        }

        // Update network info sidebar
        function updateNetworkInfo(net) {
            const infoContainer = document.getElementById('network-info');
            const s = net.stats;
            const h = net.hydraulics;
            infoContainer.innerHTML = `
                <div>File: ${net.filename}</div>
                <div class="mt-1">Total Nodes: ${s.node_count || 0}</div>
                <div>‚Ä¢ Junctions: ${s.junction_count || 0}</div>
                <div>‚Ä¢ Reservoirs: ${s.reservoir_count || 0}</div>
                <div>‚Ä¢ Tanks: ${s.tank_count || 0}</div>
                <div class="mt-1">Total Links: ${s.link_count || 0}</div>
                <div>‚Ä¢ Pipes: ${s.pipe_count || 0}</div>
                <div>‚Ä¢ Pumps: ${s.pump_count || 0}</div>
                <div>‚Ä¢ Valves: ${s.valve_count || 0}</div>
                ${h ? `
                <div class="mt-2 border-t border-gray-700 pt-2">
                    <div class="text-gray-400 text-xs font-medium">Hydraulic Summary</div>
                    <div>Avg Pressure: ${h.avg_pressure?.toFixed(2) || 'N/A'} m</div>
                    <div>Min Pressure: ${h.min_pressure?.toFixed(2) || 'N/A'} m</div>
                    <div>Max Pressure: ${h.max_pressure?.toFixed(2) || 'N/A'} m</div>
                </div>` : ''}
            `;
        }

        // Initialize visualization
        function initializeVisualization() {
            svg = d3.select('#network-svg');
            g = svg.append('g');

            // Setup zoom
            zoom = d3.zoom()
                .scaleExtent([0.001, 200])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // Zoom controls
            document.getElementById('zoom-in-btn').addEventListener('click', () => {
                svg.transition().call(zoom.scaleBy, 1.5);
            });

            document.getElementById('zoom-out-btn').addEventListener('click', () => {
                svg.transition().call(zoom.scaleBy, 1 / 1.5);
            });

            document.getElementById('reset-view-btn').addEventListener('click', () => {
                resetViewToCenter();
            });

            // Load topology button
            document.getElementById('load-topology-btn').addEventListener('click', loadTopology);

            // Size sliders
            document.getElementById('node-size-slider').addEventListener('input', (e) => {
                nodeSizeScale = parseFloat(e.target.value);
                updateNodeSizes();
            });

            document.getElementById('link-size-slider').addEventListener('input', (e) => {
                linkSizeScale = parseFloat(e.target.value);
                updateLinkSizes();
            });

            // ID display toggles
            document.getElementById('show-node-ids').addEventListener('change', (e) => {
                showNodeIds = e.target.checked;
                updateNodeLabelsVisibility();
            });

            document.getElementById('show-link-ids').addEventListener('change', (e) => {
                showLinkIds = e.target.checked;
                updateLinkLabelsVisibility();
            });

            // Hydraulic coloring toggle
            document.getElementById('show-hydraulics').addEventListener('change', (e) => {
                showHydraulics = e.target.checked;
                document.getElementById('data-legend').style.display = showHydraulics ? 'block' : 'none';
                applyColors();
            });

            // Legend controls
            document.getElementById('legend-toggle').addEventListener('click', () => {
                const legendPanel = document.getElementById('legend-panel');
                legendPanel.style.display = legendPanel.style.display === 'none' ? 'block' : 'none';
            });

            document.getElementById('legend-close').addEventListener('click', () => {
                document.getElementById('legend-panel').style.display = 'none';
            });
        }

        // Load topology from RAG
        async function loadTopology() {
            if (!selectedNetwork) return;

            const loadingIndicator = document.getElementById('loading-indicator');
            const networkSvg = document.getElementById('network-svg');

            loadingIndicator.innerHTML = `
                <div class="text-center">
                    <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <div class="text-xl text-gray-400">Loading from cache...</div>
                </div>
            `;

            try {
                const response = await fetch(`/api/topology/from_rag/${selectedNetwork.md5}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load topology');
                }

                networkData = {
                    nodes: data.stats.nodes,
                    links: data.stats.links,
                    topology: {
                        nodes: data.nodes,
                        links: data.links
                    },
                    hydraulics: data.hydraulics,
                    filename: data.filename
                };

                // Show SVG BEFORE generating topology (so getBoundingClientRect works)
                loadingIndicator.style.display = 'none';
                networkSvg.style.display = 'block';

                // Generate topology visualization
                await generateTopology();

                // Apply initial colors
                applyColors();

                // Apply initial size settings
                updateNodeSizes();
                updateLinkSizes();

                // Update current file info
                document.getElementById('current-file-info').textContent = data.filename;

            } catch (error) {
                console.error('Failed to load topology:', error);
                loadingIndicator.innerHTML = `
                    <div class="text-center">
                        <div class="text-6xl mb-4 text-red-500">‚ùå</div>
                        <div class="text-xl text-red-400">Loading Failed</div>
                        <div class="text-sm text-gray-500 mt-2">${error.message}</div>
                    </div>
                `;
            }
        }

        // Generate topology visualization
        async function generateTopology() {
            // Clear previous visualization
            g.selectAll('*').remove();

            if (!networkData || !networkData.topology) {
                throw new Error('Network topology data unavailable');
            }

            const nodes = networkData.topology.nodes;
            const links = networkData.topology.links;

            if (nodes.length === 0) {
                throw new Error('No node data in network');
            }

            // Calculate coordinate range
            const xCoords = nodes.map(n => n.coordinates[0]).filter(x => x !== undefined && x !== null);
            const yCoords = nodes.map(n => n.coordinates[1]).filter(y => y !== undefined && y !== null);

            let xMin = Math.min(...xCoords);
            let xMax = Math.max(...xCoords);
            let yMin = Math.min(...yCoords);
            let yMax = Math.max(...yCoords);

            if (!isFinite(xMin) || !isFinite(xMax) || !isFinite(yMin) || !isFinite(yMax)) {
                xMin = 0; xMax = 1000; yMin = 0; yMax = 1000;
            }

            // Add margin
            const margin = Math.max((xMax - xMin), (yMax - yMin)) * 0.1;
            xMin -= margin; xMax += margin;
            yMin -= margin; yMax += margin;

            // Get SVG dimensions
            const svgRect = svg.node().getBoundingClientRect();
            const svgWidth = svgRect.width;
            const svgHeight = svgRect.height;

            // Calculate scale ratio
            const scaleX = svgWidth / (xMax - xMin);
            const scaleY = svgHeight / (yMax - yMin);
            const scale = Math.min(scaleX, scaleY) * 0.9;

            // Prepare data
            const nodeData = nodes.map(node => {
                let x = node.coordinates[0];
                let y = node.coordinates[1];

                if (x === undefined || x === null || y === undefined || y === null) {
                    x = xMin + Math.random() * (xMax - xMin);
                    y = yMin + Math.random() * (yMax - yMin);
                }

                // Coordinate system transformation (Y-axis flip)
                const transformedX = (x - xMin) * scale;
                const transformedY = svgHeight - (y - yMin) * scale;

                return {
                    id: node.id,
                    type: node.type,
                    x: transformedX,
                    y: transformedY,
                    originalX: x,
                    originalY: y,
                    elevation: node.elevation || 0,
                    base_demand: node.base_demand || 0,
                    pressure_avg: node.pressure_avg,
                    head_avg: node.head_avg,
                    demand_avg: node.demand_avg,
                    ...node
                };
            });

            const linkData = links.map(link => ({
                source: link.start_node,
                target: link.end_node,
                id: link.id,
                type: link.type,
                length: link.length || 0,
                diameter: link.diameter || 0,
                roughness: link.roughness || 0,
                flowrate_avg: link.flowrate_avg,
                velocity_avg: link.velocity_avg,
                ...link
            }));

            // Create node ID to data mapping
            const nodeMap = new Map();
            nodeData.forEach(node => nodeMap.set(node.id, node));

            // Create links
            const linkGroup = g.append('g').attr('class', 'links');
            linkElements = linkGroup.selectAll('line')
                .data(linkData)
                .enter().append('line')
                .attr('class', d => `link ${d.type}`)
                .attr('stroke-width', d => {
                    const baseWidth = d.type === 'pump' ? 4 : d.type === 'valve' ? 3 : Math.max(1, Math.min(8, (d.diameter || 100) / 50));
                    return baseWidth * linkSizeScale;
                })
                .attr('x1', d => {
                    const sourceNode = nodeMap.get(d.source);
                    return sourceNode ? sourceNode.x : 0;
                })
                .attr('y1', d => {
                    const sourceNode = nodeMap.get(d.source);
                    return sourceNode ? sourceNode.y : 0;
                })
                .attr('x2', d => {
                    const targetNode = nodeMap.get(d.target);
                    return targetNode ? targetNode.x : 0;
                })
                .attr('y2', d => {
                    const targetNode = nodeMap.get(d.target);
                    return targetNode ? targetNode.y : 0;
                })
                .on('mouseover', showLinkTooltip)
                .on('mouseout', hideTooltip)
                .on('click', showLinkDetails);

            // Create nodes
            nodeElements = g.append('g')
                .attr('class', 'nodes')
                .selectAll('circle')
                .data(nodeData)
                .enter().append('circle')
                .attr('class', d => `node ${d.type}`)
                .attr('r', d => {
                    const baseRadius = d.type === 'reservoir' ? 12 : d.type === 'tank' ? 10 : 6;
                    return baseRadius * nodeSizeScale;
                })
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .on('mouseover', showNodeTooltip)
                .on('mouseout', hideTooltip)
                .on('click', showNodeDetails);

            // Add node labels
            nodeLabels = g.append('g')
                .attr('class', 'node-labels')
                .selectAll('text')
                .data(nodeData)
                .enter().append('text')
                .attr('x', d => d.x + 12)
                .attr('y', d => d.y + 4)
                .attr('font-size', '10px')
                .attr('fill', '#9ca3af')
                .style('display', 'none')
                .text(d => d.id);

            // Add link labels
            linkLabels = g.append('g')
                .attr('class', 'link-labels')
                .selectAll('text')
                .data(linkData)
                .enter().append('text')
                .attr('x', d => {
                    const sourceNode = nodeMap.get(d.source);
                    const targetNode = nodeMap.get(d.target);
                    return sourceNode && targetNode ? (sourceNode.x + targetNode.x) / 2 : 0;
                })
                .attr('y', d => {
                    const sourceNode = nodeMap.get(d.source);
                    const targetNode = nodeMap.get(d.target);
                    return sourceNode && targetNode ? (sourceNode.y + targetNode.y) / 2 : 0;
                })
                .attr('font-size', '9px')
                .attr('fill', '#6b7280')
                .attr('text-anchor', 'middle')
                .style('display', 'none')
                .text(d => d.id);

            // Auto-zoom to fit view
            const bounds = g.node().getBBox();
            const fullWidth = svgWidth;
            const fullHeight = svgHeight;
            const width = bounds.width;
            const height = bounds.height;
            const midX = bounds.x + width / 2;
            const midY = bounds.y + height / 2;

            if (width == 0 || height == 0) return;

            const scaleToFit = 0.9 / Math.max(width / fullWidth, height / fullHeight);
            const translate = [fullWidth / 2 - scaleToFit * midX, fullHeight / 2 - scaleToFit * midY];

            svg.call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scaleToFit));
        }

        // Apply colors (topology default or hydraulic)
        function applyColors() {
            if (!nodeElements || !linkElements) return;

            if (showHydraulics) {
                // Color nodes by average pressure
                nodeElements.style('fill', d => {
                    if (d.pressure_avg !== undefined && d.pressure_avg !== null) {
                        const normalizedPressure = Math.min(1, Math.max(0, d.pressure_avg / 80));
                        const hue = (1 - normalizedPressure) * 240; // 240=Blue, 0=Red
                        return `hsl(${hue}, 70%, 50%)`;
                    }
                    // Fallback to type colors
                    if (d.type === 'reservoir') return '#10b981';
                    if (d.type === 'tank') return '#f59e0b';
                    return '#3b82f6';
                });

                // Color links by average flowrate
                linkElements.style('stroke', d => {
                    if (d.flowrate_avg !== undefined && d.flowrate_avg !== null) {
                        const absFlow = Math.abs(d.flowrate_avg);
                        const normalizedFlow = Math.min(1, absFlow / 0.05);
                        const intensity = Math.floor(normalizedFlow * 200 + 55);
                        return d.flowrate_avg >= 0 ? `rgb(0, ${intensity}, 0)` : `rgb(${intensity}, 0, 0)`;
                    }
                    if (d.type === 'pump') return '#ef4444';
                    if (d.type === 'valve') return '#8b5cf6';
                    return '#6b7280';
                });
            } else {
                // Default topology colors
                nodeElements.style('fill', d => {
                    switch (d.type) {
                        case 'reservoir': return '#10b981';
                        case 'tank': return '#f59e0b';
                        case 'junction': return '#3b82f6';
                        default: return '#6b7280';
                    }
                });

                linkElements.style('stroke', d => {
                    switch (d.type) {
                        case 'pump': return '#ef4444';
                        case 'valve': return '#8b5cf6';
                        case 'pipe': return '#6b7280';
                        default: return '#6b7280';
                    }
                });
            }
        }

        // Reset view to center and fit
        function resetViewToCenter() {
            if (!g || !svg) return;

            try {
                const bounds = g.node().getBBox();
                const svgRect = svg.node().getBoundingClientRect();
                const fullWidth = svgRect.width;
                const fullHeight = svgRect.height;
                const width = bounds.width;
                const height = bounds.height;
                const midX = bounds.x + width / 2;
                const midY = bounds.y + height / 2;

                if (width == 0 || height == 0) {
                    svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
                    return;
                }

                const scaleToFit = 0.9 / Math.max(width / fullWidth, height / fullHeight);
                const translate = [fullWidth / 2 - scaleToFit * midX, fullHeight / 2 - scaleToFit * midY];

                svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scaleToFit));
            } catch (error) {
                console.warn('Reset view failed:', error);
                svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
            }
        }

        // Show node tooltip
        function showNodeTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');

            let hydraulicInfo = '';
            if (d.pressure_avg !== undefined && d.pressure_avg !== null) {
                hydraulicInfo = `
                    <div class="border-t border-gray-600 mt-2 pt-2">
                        <div class="text-yellow-300 font-medium">Avg Hydraulics:</div>
                        <div>Pressure: ${d.pressure_avg.toFixed(2)} m</div>
                        ${d.head_avg !== undefined ? `<div>Total Head: ${d.head_avg.toFixed(2)} m</div>` : ''}
                        ${d.demand_avg !== undefined ? `<div>Demand: ${d.demand_avg.toFixed(6)} L/s</div>` : ''}
                    </div>
                `;
            }

            tooltip.innerHTML = `
                <div class="font-semibold">${d.type.toUpperCase()}: ${d.id}</div>
                <div class="text-xs mt-1">
                    <div>Elevation: ${d.elevation?.toFixed(2) || 'N/A'} m</div>
                    ${d.base_demand !== undefined ? `<div>Base Demand: ${d.base_demand.toFixed(6)} L/s</div>` : ''}
                    ${hydraulicInfo}
                </div>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        // Show link tooltip
        function showLinkTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');

            let hydraulicInfo = '';
            if (d.flowrate_avg !== undefined && d.flowrate_avg !== null) {
                hydraulicInfo = `
                    <div class="border-t border-gray-600 mt-2 pt-2">
                        <div class="text-yellow-300 font-medium">Avg Hydraulics:</div>
                        <div>Flowrate: ${d.flowrate_avg.toFixed(6)} m¬≥/s</div>
                        ${d.velocity_avg !== undefined ? `<div>Velocity: ${d.velocity_avg.toFixed(4)} m/s</div>` : ''}
                    </div>
                `;
            }

            tooltip.innerHTML = `
                <div class="font-semibold">${d.type.toUpperCase()}: ${d.id}</div>
                <div class="text-xs mt-1">
                    <div>Start Node: ${d.source}</div>
                    <div>End Node: ${d.target}</div>
                    ${d.length !== undefined ? `<div>Length: ${d.length.toFixed(2)} m</div>` : ''}
                    ${d.diameter !== undefined ? `<div>Diameter: ${(d.diameter * 1000).toFixed(0)} mm</div>` : ''}
                    ${d.roughness !== undefined ? `<div>Roughness: ${d.roughness}</div>` : ''}
                    ${hydraulicInfo}
                </div>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        // Hide tooltip
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // Show detailed node information
        function showNodeDetails(event, d) {
            let details = `Node Details:\n\nID: ${d.id}\nType: ${d.type}\nElevation: ${d.elevation?.toFixed(2) || 'N/A'} m\nBase Demand: ${d.base_demand?.toFixed(6) || 'N/A'} L/s`;

            if (d.pressure_avg !== undefined) {
                details += `\n\n=== Avg Hydraulics ===`;
                details += `\nPressure: ${d.pressure_avg.toFixed(2)} m`;
                if (d.head_avg !== undefined) details += `\nTotal Head: ${d.head_avg.toFixed(2)} m`;
                if (d.demand_avg !== undefined) details += `\nDemand: ${d.demand_avg.toFixed(6)} L/s`;
            }

            alert(details);
        }

        // Show detailed link information
        function showLinkDetails(event, d) {
            let details = `Link Details:\n\nID: ${d.id}\nType: ${d.type}\nStart Node: ${d.source}\nEnd Node: ${d.target}\nLength: ${d.length?.toFixed(2) || 'N/A'} m\nDiameter: ${d.diameter ? (d.diameter * 1000).toFixed(0) : 'N/A'} mm\nRoughness: ${d.roughness || 'N/A'}`;

            if (d.flowrate_avg !== undefined) {
                details += `\n\n=== Avg Hydraulics ===`;
                details += `\nFlowrate: ${d.flowrate_avg.toFixed(6)} m¬≥/s`;
                if (d.velocity_avg !== undefined) details += `\nVelocity: ${d.velocity_avg.toFixed(4)} m/s`;
            }

            alert(details);
        }

        // Update node sizes
        function updateNodeSizes() {
            if (!nodeElements) return;
            nodeElements.attr('r', d => {
                const baseRadius = d.type === 'reservoir' ? 12 : d.type === 'tank' ? 10 : 6;
                return baseRadius * nodeSizeScale;
            });
        }

        // Update link sizes
        function updateLinkSizes() {
            if (!linkElements) return;
            linkElements.attr('stroke-width', function (d) {
                const baseWidth = d.type === 'pump' ? 4 : d.type === 'valve' ? 3 : Math.max(1, Math.min(8, (d.diameter || 100) / 50));
                return baseWidth * linkSizeScale;
            });
        }

        // Update node labels visibility
        function updateNodeLabelsVisibility() {
            if (!nodeLabels) return;
            nodeLabels.style('display', showNodeIds ? 'block' : 'none');
        }

        // Update link labels visibility
        function updateLinkLabelsVisibility() {
            if (!linkLabels) return;
            linkLabels.style('display', showLinkIds ? 'block' : 'none');
        }
    </script>

</html>